<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="WDWA Legal Document Compliance, Telemetry & Stamping Engine">
<meta name="author" content="Evanscira Labs">
<title>SRC-D // SHADEPROOF // OMEGA PLATINUM</title>

<!-- ======================================================================= -->
<!-- EXTERNAL LIBRARIES (CDN)                                                -->
<!-- ======================================================================= -->

<!-- PDF.js: Rendering Engine -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>

<!-- PDF-Lib: Modification & Stamping Engine -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<style>
/* 
   ==========================================================================
   SRC-D // DESIGN SYSTEM // OMEGA PLATINUM
   ==========================================================================
   
   A high-contrast, data-dense interface designed for legal technical 
   compliance. Uses a "Deep Space" palette with tactical HUD elements.
*/

:root {
  /* --- PALETTE: BACKGROUNDS --- */
  --bg-void:    #05070a;  /* Deepest background */
  --bg-panel:   #0d1117;  /* Sidebar/Header background */
  --bg-input:   #161b22;  /* Input fields */
  --bg-modal:   rgba(5, 7, 10, 0.90); /* Modal backdrop */
  
  /* --- PALETTE: BORDERS & LINES --- */
  --border:     #30363d;  /* Standard borders */
  --border-hl:  #58a6ff;  /* Highlight/Active borders */
  --grid-line:  rgba(0, 230, 118, 0.2); /* Compliance Grid */
  
  /* --- PALETTE: TYPOGRAPHY --- */
  --text-main:  #c9d1d9;  /* Primary text */
  --text-mute:  #8b949e;  /* Secondary/Label text */
  --text-inv:   #05070a;  /* Inverted text (on buttons) */
  
  /* --- PALETTE: STATUS INDICATORS --- */
  --accent:     #3d5afe;  /* Primary Brand Color (Blue) */
  --status-ok:  #238636;  /* Success/Valid (Green) */
  --status-chk: #d29922;  /* Warning/Check Needed (Amber) */
  --status-err: #f85149;  /* Error/Invalid (Red) */

  /* --- DIMENSIONS --- */
  --sidebar-w:  360px;    /* Fixed width for controls */
  --header-h:   56px;     /* Header height */
  --footer-h:   28px;     /* Footer height */
  --ruler-size: 28px;     /* Thickness of ruler bars */
  
  /* --- TYPOGRAPHY CONFIG --- */
  --font-mono: 'JetBrains Mono', 'SF Mono', 'Segoe UI Mono', 'Courier New', monospace;
  --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

/* --- GLOBAL RESET --- */
* { 
  box-sizing: border-box; 
  outline: none; 
  -webkit-font-smoothing: antialiased; 
}

html, body {
  margin: 0; 
  padding: 0;
  background-color: var(--bg-void);
  color: var(--text-main);
  font-family: var(--font-mono);
  font-size: 12px;
  height: 100vh; 
  width: 100vw;
  overflow: hidden; /* App handles its own scrolling */
  display: flex; 
  flex-direction: column;
}

/* --- SCROLLBAR CUSTOMIZATION --- */
::-webkit-scrollbar { 
  width: 10px; 
  height: 10px; 
  background: var(--bg-void); 
}
::-webkit-scrollbar-track { 
  background: var(--bg-panel); 
  border-left: 1px solid var(--border); 
}
::-webkit-scrollbar-thumb { 
  background: #30363d; 
  border: 2px solid var(--bg-panel); 
  border-radius: 6px; 
}
::-webkit-scrollbar-thumb:hover { 
  background: var(--border-hl); 
}

/* --- UTILITY CLASSES --- */
.hidden { display: none !important; }
.flex-row { display: flex; align-items: center; gap: 8px; }
.flex-col { display: flex; flex-direction: column; gap: 8px; }
.flex-between { display: flex; align-items: center; justify-content: space-between; }
.text-xs { font-size: 10px; letter-spacing: 0.5px; }
.text-hl { color: var(--border-hl); }
.mono-bold { font-weight: 700; }
.w-full { width: 100%; }
.no-select { user-select: none; }

/* ==========================================================================
   HEADER COMPONENT
   ========================================================================== */
header {
  height: var(--header-h);
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  padding: 0 16px;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.brand-group { 
  display: flex; 
  align-items: center; 
  gap: 16px; 
}

.brand-main { 
  font-weight: 800; 
  font-size: 14px; 
  letter-spacing: 1.5px; 
  color: var(--text-main); 
  text-shadow: 0 0 15px rgba(61, 90, 254, 0.3); 
}

/* Sidebar Toggle Button */
#btn-toggle-sidebar {
  background: transparent; 
  border: 1px solid var(--border); 
  color: var(--text-mute);
  width: 32px; 
  height: 32px; 
  border-radius: 4px; 
  cursor: pointer;
  display: flex; 
  align-items: center; 
  justify-content: center;
  transition: all 0.2s ease;
}
#btn-toggle-sidebar:hover { 
  border-color: var(--border-hl); 
  color: var(--border-hl); 
  background: rgba(88, 166, 255, 0.1); 
}
#btn-toggle-sidebar svg { 
  width: 16px; 
  height: 16px; 
  fill: currentColor; 
}

.header-tools { 
  display: flex; 
  gap: 12px; 
  align-items: center; 
}

/* --- BUTTON STYLES --- */
button.btn {
  background: var(--bg-input); 
  border: 1px solid var(--border); 
  color: var(--text-main);
  padding: 6px 14px; 
  border-radius: 4px; 
  font-family: var(--font-mono); 
  font-size: 11px;
  cursor: pointer; 
  transition: all 0.2s; 
  text-transform: uppercase; 
  letter-spacing: 0.5px;
  display: inline-flex; 
  align-items: center; 
  gap: 6px;
}
button.btn:hover { 
  border-color: var(--text-mute); 
  background: #21262d; 
}
button.btn:active { 
  border-color: var(--border-hl); 
  color: var(--border-hl); 
  transform: translateY(1px); 
}
button.btn:disabled { 
  opacity: 0.5; 
  cursor: not-allowed; 
  pointer-events: none; 
}

/* Special Close Button Style */
#btn-close { 
  border-color: var(--status-err); 
  color: var(--status-err); 
}
#btn-close:hover { 
  background: rgba(248, 81, 73, 0.1); 
  border-color: #ff8080;
}

/* ==========================================================================
   MAIN LAYOUT
   ========================================================================== */
#layout-grid {
  display: flex;
  height: calc(100vh - var(--header-h) - var(--footer-h));
  width: 100vw;
  position: relative;
  overflow: hidden;
}

/* ==========================================================================
   SIDEBAR COMPONENT
   ========================================================================== */
aside {
  width: var(--sidebar-w);
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  display: flex; 
  flex-direction: column;
  overflow-y: auto;
  flex-shrink: 0;
  transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 90;
}

/* Collapsed State Logic */
aside.collapsed { 
  margin-left: calc(var(--sidebar-w) * -1); 
}

.panel-block { 
  padding: 16px; 
  border-bottom: 1px solid var(--border); 
}

.panel-title {
  font-size: 10px; 
  font-weight: 700; 
  color: var(--text-mute);
  text-transform: uppercase; 
  letter-spacing: 1px; 
  margin-bottom: 12px;
  display: flex; 
  justify-content: space-between; 
  align-items: center;
}

/* --- HUB LINKS (External Resources) --- */
.hub-grid { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 8px; 
}
a.hub-link {
  display: flex; 
  flex-direction: column; 
  background: #12161c;
  border: 1px solid var(--border); 
  padding: 10px; 
  text-decoration: none;
  border-radius: 4px; 
  transition: all 0.2s; 
  position: relative; 
  overflow: hidden;
}
a.hub-link:hover { 
  border-color: var(--border-hl); 
  background: #1c2128; 
}
a.hub-link::after {
  content: ''; 
  position: absolute; 
  top: 0; left: 0; 
  width: 2px; height: 100%;
  background: var(--border-hl); 
  opacity: 0; 
  transition: opacity 0.2s;
}
a.hub-link:hover::after { opacity: 1; }

.hub-link-title { 
  font-size: 10px; 
  font-weight: 700; 
  color: var(--text-main); 
  margin-bottom: 2px; 
}
.hub-link-sub { 
  font-size: 9px; 
  color: var(--text-mute); 
}

/* --- STAMPING INPUTS --- */
.input-group { margin-bottom: 10px; }
.input-label { 
  font-size: 9px; 
  color: var(--text-mute); 
  margin-bottom: 4px; 
  display: block; 
  text-transform: uppercase;
}
input[type="text"] {
  width: 100%; 
  background: #05070a; 
  border: 1px solid var(--border);
  color: var(--text-main); 
  padding: 8px 10px; 
  font-family: var(--font-mono);
  font-size: 11px; 
  border-radius: 4px; 
  transition: border 0.2s;
}
input[type="text"]:focus { 
  border-color: var(--border-hl); 
}
input[type="text"]::placeholder {
  color: #333;
}

/* --- DATA GRID (Telemetry) --- */
.data-grid { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 12px; 
}
.data-item { 
  display: flex; 
  flex-direction: column; 
  gap: 3px; 
}
.data-lbl { 
  font-size: 9px; 
  color: var(--text-mute); 
}
.data-val { 
  font-size: 11px; 
  font-weight: 600; 
  color: var(--text-main); 
  font-family: var(--font-mono); 
}
.data-val.ok { color: var(--status-ok); }
.data-val.chk { color: var(--status-chk); }
.data-val.err { color: var(--status-err); }

/* --- CONTROLS (Sliders & Checks) --- */
.slider-row { 
  display: flex; 
  align-items: center; 
  gap: 10px; 
  font-size: 10px; 
  margin-bottom: 10px; 
}
input[type="range"] {
  flex: 1; 
  -webkit-appearance: none; 
  background: transparent; 
  height: 20px; 
  cursor: pointer;
}
input[type="range"]::-webkit-slider-runnable-track {
  width: 100%; 
  height: 4px; 
  background: var(--border); 
  border-radius: 2px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; 
  height: 12px; 
  width: 12px; 
  border-radius: 50%;
  background: var(--text-main); 
  margin-top: -4px; 
  box-shadow: 0 0 0 2px var(--bg-panel);
  transition: background 0.2s, transform 0.2s;
}
input[type="range"]::-webkit-slider-thumb:hover { 
  background: var(--border-hl); 
  transform: scale(1.2); 
}

.chk-row {
  display: flex; 
  align-items: center; 
  gap: 10px; 
  padding: 6px 0;
  cursor: pointer; 
  color: var(--text-mute); 
  transition: color 0.2s;
}
.chk-row:hover { color: var(--text-main); }
.chk-row input { 
  accent-color: var(--border-hl); 
  width: 14px; 
  height: 14px; 
}

/* --- SYSTEM LOG --- */
#console-output {
  flex: 1; 
  background: #000; 
  padding: 12px; 
  font-family: 'Courier New', monospace;
  font-size: 10px; 
  line-height: 1.5; 
  overflow-y: auto; 
  border-top: 1px solid var(--border);
  min-height: 150px;
}
.log-line { 
  margin-bottom: 4px; 
  border-left: 2px solid transparent; 
  padding-left: 8px; 
  word-break: break-all; 
}
.log-line.sys { color: var(--text-mute); border-color: var(--border); }
.log-line.ok { color: var(--status-ok); border-color: var(--status-ok); }
.log-line.guide { color: var(--status-chk); border-color: var(--status-chk); }
.log-line.err { color: var(--status-err); border-color: var(--status-err); }
.ts { color: #444; margin-right: 8px; user-select: none; }

/* ==========================================================================
   VIEWER STAGE
   ========================================================================== */
main {
  flex: 1; 
  background: #090c10; 
  position: relative; 
  overflow: hidden;
  display: flex; 
  flex-direction: column;
}

/* --- STANDBY SCREEN --- */
#standby-screen {
  position: absolute; 
  inset: 0; 
  display: flex; 
  flex-direction: column;
  align-items: center; 
  justify-content: center; 
  color: var(--text-mute);
  z-index: 10; 
  pointer-events: none;
  background: radial-gradient(circle at center, #161b22 0%, #090c10 70%);
}
.standby-icon { 
  font-size: 64px; 
  color: #1c2128; 
  margin-bottom: 24px; 
  text-shadow: 0 0 30px rgba(61, 90, 254, 0.1);
  animation: pulse-slow 4s infinite ease-in-out;
}
.standby-text { 
  font-size: 14px; 
  letter-spacing: 3px; 
  font-weight: 700; 
  color: #30363d; 
}
.standby-sub { 
  font-size: 10px; 
  color: #222; 
  margin-top: 8px; 
}

@keyframes pulse-slow { 
  0%, 100% { opacity: 0.8; transform: scale(1); } 
  50% { opacity: 1; transform: scale(1.05); } 
}

/* --- DROP ZONE --- */
#drop-overlay {
  position: absolute; 
  inset: 0; 
  background: rgba(13, 17, 23, 0.95);
  backdrop-filter: blur(8px); 
  z-index: 500;
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  justify-content: center;
  border: 2px dashed var(--border-hl); 
  color: var(--border-hl);
  opacity: 0; 
  pointer-events: none; 
  transition: opacity 0.2s;
}
#drop-overlay.active { 
  opacity: 1; 
  pointer-events: auto; 
}
.drop-msg { 
  font-size: 16px; 
  letter-spacing: 2px; 
  font-weight: 700; 
  margin-bottom: 8px; 
}
.drop-sub { 
  font-size: 11px; 
  color: var(--text-mute); 
}

/* --- VIEWPORT & CANVAS --- */
#viewport {
  flex: 1; 
  overflow: auto; 
  display: flex; 
  padding: 60px; /* Generous padding for scrolling past edges */
  background-image: 
    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size: 20px 20px;
  cursor: grab;
}
#viewport:active { cursor: grabbing; }

.page-container {
  position: relative; 
  background: #fff; 
  box-shadow: 0 0 100px rgba(0,0,0,0.8);
  margin: auto; /* Centers in viewport */
  transform-origin: center top;
}

canvas { display: block; }

/* ==========================================================================
   OVERLAYS & RULERS
   ========================================================================== */
.layer { 
  position: absolute; 
  inset: 0; 
  pointer-events: none; 
}

/* Rulers - Sticky to Page */
.ruler {
  position: absolute; 
  background: rgba(255,255,255,0.98); 
  z-index: 50; 
  font-family: var(--font-sans); 
  font-size: 9px; 
  color: #111;
  pointer-events: none; 
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

/* Top Ruler (X-Axis) */
.ruler.top {
  top: calc(var(--ruler-size) * -1); 
  left: 0; 
  right: 0;
  height: var(--ruler-size);
  border-bottom: 1px solid #333;
  border-top-left-radius: 4px; 
  border-top-right-radius: 4px;
}

/* Left Ruler (Y-Axis) */
.ruler.left {
  left: calc(var(--ruler-size) * -1); 
  top: 0; 
  bottom: 0;
  width: var(--ruler-size);
  border-right: 1px solid #333;
  border-top-left-radius: 4px; 
  border-bottom-left-radius: 4px;
}

/* Corner Piece */
.ruler-corner {
  position: absolute; 
  top: calc(var(--ruler-size) * -1); 
  left: calc(var(--ruler-size) * -1);
  width: var(--ruler-size); 
  height: var(--ruler-size);
  background: #eee; 
  border-right: 1px solid #333; 
  border-bottom: 1px solid #333;
  z-index: 51; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 8px; 
  color: #555; 
  font-weight: bold;
}

/* Ticks */
.tick { position: absolute; background: #333; }
.tick-lbl { position: absolute; font-size: 8px; color: #333; font-weight: 600; }

/* Margin Zone */
.margin-zone {
  position: absolute; 
  border: 2px dashed rgba(61, 90, 254, 0.5);
  background: rgba(61, 90, 254, 0.03); 
  z-index: 10;
  transition: all 0.3s ease;
}
.margin-zone.guidance-needed { 
  border-color: var(--status-chk); 
  background: rgba(210, 153, 34, 0.1); 
  animation: pulse-border 2s infinite;
}
@keyframes pulse-border { 
  0% { border-opacity: 1; } 
  50% { border-opacity: 0.5; } 
  100% { border-opacity: 1; } 
}

/* Grid */
.grid-line { 
  position: absolute; 
  width: 100%; 
  border-top: 1px solid rgba(0, 230, 118, 0.2); 
}
.grid-line.major { 
  border-color: rgba(0, 230, 118, 0.5); 
  border-top-width: 1px; 
}

/* ==========================================================================
   MODALS
   ========================================================================== */
.modal-backdrop {
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,0.7); 
  backdrop-filter: blur(2px);
  z-index: 1000; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  opacity: 0; 
  pointer-events: none; 
  transition: opacity 0.2s;
}
.modal-backdrop.active { 
  opacity: 1; 
  pointer-events: auto; 
}

.modal-panel {
  background: var(--bg-panel); 
  border: 1px solid var(--border);
  width: 500px; 
  max-width: 90vw; 
  border-radius: 8px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  display: flex; 
  flex-direction: column;
}
.modal-header {
  padding: 15px 20px; 
  border-bottom: 1px solid var(--border);
  display: flex; 
  justify-content: space-between; 
  align-items: center;
}
.modal-title { 
  font-size: 14px; 
  font-weight: 700; 
  color: var(--text-main); 
  letter-spacing: 1px; 
}
.modal-close { 
  background: none; 
  border: none; 
  color: var(--text-mute); 
  cursor: pointer; 
  font-size: 16px; 
}
.modal-close:hover { color: var(--text-main); }
.modal-body { 
  padding: 20px; 
  font-size: 12px; 
  color: var(--text-mute); 
  line-height: 1.6; 
}

.shortcut-row { 
  display: flex; 
  justify-content: space-between; 
  margin-bottom: 8px; 
  border-bottom: 1px solid #222; 
  padding-bottom: 4px; 
}
.key-combo { 
  font-family: var(--font-mono); 
  color: var(--border-hl); 
  background: rgba(88, 166, 255, 0.1); 
  padding: 2px 6px; 
  border-radius: 4px; 
  font-size: 10px; 
}

/* ==========================================================================
   FOOTER
   ========================================================================== */
footer {
  height: var(--footer-h); 
  background: var(--bg-panel); 
  border-top: 1px solid var(--border);
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  padding: 0 15px;
  font-size: 10px; 
  color: var(--text-mute); 
  z-index: 100;
}
.status-dot { 
  display: inline-block; 
  width: 6px; 
  height: 6px; 
  border-radius: 50%; 
  background: #444; 
  margin-right: 6px; 
}
.status-dot.active { 
  background: var(--status-ok); 
  box-shadow: 0 0 8px var(--status-ok); 
}
.status-dot.busy { 
  background: var(--status-chk); 
  animation: pulse 1s infinite; 
}

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="brand-group">
    <button id="btn-toggle-sidebar" title="Toggle Sidebar (Ctrl+B)">
      <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>
    <span class="brand-main">SRC-D // SHADEPROOF</span>
  </div>
  
  <div class="header-tools">
    <input type="file" id="inp-file" accept=".pdf" class="hidden">
    
    <!-- Dynamic Button Group: Swaps Load/Close based on state -->
    <div id="btn-group-load">
      <button class="btn" onclick="document.getElementById('inp-file').click()">
        <span>Load PDF</span>
      </button>
    </div>
    <div id="btn-group-close" class="hidden">
      <button class="btn" id="btn-close" onclick="closeDocument()">
        <span>CLOSE FILE</span>
      </button>
    </div>

    <button class="btn" id="btn-help" title="Shortcuts (?)">?</button>
    
    <div class="flex-row" id="nav-group" style="opacity: 0.3; pointer-events: none;">
      <button class="btn" id="btn-prev" title="Previous Page (Left Arrow)">Prev</button>
      <span id="lbl-page" class="mono-bold" style="min-width: 60px; text-align: center;">-- / --</span>
      <button class="btn" id="btn-next" title="Next Page (Right Arrow)">Next</button>
    </div>
  </div>
</header>

<!-- MAIN LAYOUT -->
<div id="layout-grid">
  
  <!-- SIDEBAR -->
  <aside id="main-sidebar">
    
    <!-- 1. EXTERNAL UPLINKS -->
    <div class="panel-block">
      <div class="panel-title"><span>External Uplinks</span></div>
      <div class="hub-grid">
        <a href="https://www.uscourts.gov/forms/civil-forms/civil-cover-sheet" target="_blank" class="hub-link">
          <span class="hub-link-title">JS-44 FORM</span>
          <span class="hub-link-sub">Civil Cover Sheet</span>
        </a>
        <a href="https://www.uscourts.gov/forms/civil-forms/summons-civil-action" target="_blank" class="hub-link">
          <span class="hub-link-title">AO-440 FORM</span>
          <span class="hub-link-sub">Summons</span>
        </a>
        <a href="https://www.wawd.uscourts.gov/local-rules-and-orders" target="_blank" class="hub-link">
          <span class="hub-link-title">LOCAL RULES</span>
          <span class="hub-link-sub">LCR Reference</span>
        </a>
        <a href="https://ecf.wawd.uscourts.gov/" target="_blank" class="hub-link">
          <span class="hub-link-title">ECF PORTAL</span>
          <span class="hub-link-sub">Filing System</span>
        </a>
      </div>
    </div>

    <!-- 2. DOCUMENT STAMPING (NEW FEATURE) -->
    <div class="panel-block">
      <div class="panel-title"><span>Footer Stamping</span></div>
      <div class="input-group">
        <span class="input-label">CASE NUMBER</span>
        <input type="text" id="inp-case" placeholder="e.g. 2:26-cv-00000-SEA">
      </div>
      <div class="input-group">
        <span class="input-label">DOCUMENT TITLE</span>
        <input type="text" id="inp-title" placeholder="e.g. PLAINTIFF'S MOTION">
      </div>
      <div class="input-group">
        <span class="input-label">ATTORNEY / FIRM</span>
        <input type="text" id="inp-atty" placeholder="e.g. Smith & Associates, LLP">
      </div>
      <button class="btn w-full" id="btn-stamp" style="justify-content: center; margin-top: 8px;">
        STAMP & DOWNLOAD PDF
      </button>
    </div>

    <!-- 3. TELEMETRY -->
    <div class="panel-block">
      <div class="panel-title"><span>Telemetry</span></div>
      <div class="data-grid">
        <div class="data-item">
          <span class="data-lbl">DIMENSIONS</span>
          <span class="data-val" id="tel-dim">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">ORIENTATION</span>
          <span class="data-val" id="tel-orient">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">TOP MARGIN</span>
          <span class="data-val" id="tel-margin">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">CONTENT CHECK</span>
          <span class="data-val" id="tel-check">WAITING</span>
        </div>
      </div>
    </div>

    <!-- 4. METADATA -->
    <div class="panel-block">
      <div class="panel-title"><span>File Metadata</span></div>
      <div class="data-grid">
        <div class="data-item">
          <span class="data-lbl">FILE SIZE</span>
          <span class="data-val" id="meta-size">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">PDF VERSION</span>
          <span class="data-val" id="meta-ver">--</span>
        </div>
        <div class="data-item" style="grid-column: span 2;">
          <span class="data-lbl">PRODUCER</span>
          <span class="data-val" id="meta-prod" style="font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">--</span>
        </div>
      </div>
    </div>

    <!-- 5. OPTICS & CALIBRATION -->
    <div class="panel-block">
      <div class="panel-title"><span>Optics & Calibration</span></div>
      
      <div class="flex-col">
        <!-- Zoom -->
        <div class="slider-row">
          <span class="text-xs w-full">ZOOM: <span id="val-zoom" class="text-hl">AUTO</span></span>
        </div>
        <div class="slider-row">
          <span>-</span>
          <input type="range" id="rng-zoom" min="25" max="200" value="100" step="5">
          <span>+</span>
        </div>
        
        <!-- Grid Offset -->
        <div class="slider-row" style="margin-top: 8px;">
          <span class="text-xs w-full">GRID Y-OFFSET: <span id="val-offset" class="text-hl">0px</span></span>
          <button class="btn" id="btn-rst-grid" style="padding: 2px 6px; font-size: 9px;">RESET</button>
        </div>
        <div class="slider-row">
          <input type="range" id="rng-offset" min="-30" max="30" value="0">
        </div>

        <!-- Grid Density -->
        <div class="slider-row" style="margin-top: 8px;">
          <span class="text-xs w-full">GRID DENSITY: <span id="val-density" class="text-hl">28 LINES</span></span>
        </div>
        <div class="slider-row">
          <input type="range" id="rng-density" min="24" max="32" value="28" step="1">
        </div>
      </div>
    </div>

    <!-- 6. LAYERS -->
    <div class="panel-block">
      <div class="panel-title"><span>Visual Layers</span></div>
      <label class="chk-row"><input type="checkbox" id="chk-grid" checked> <span>Line Grid System</span></label>
      <label class="chk-row"><input type="checkbox" id="chk-margin" checked> <span>Safety Zone Overlay</span></label>
      <label class="chk-row"><input type="checkbox" id="chk-ruler" checked> <span>Precision Rulers</span></label>
    </div>

    <!-- 7. LOG -->
    <div id="console-output">
      <div class="log-line sys"><span class="ts">00:00:00</span>SYSTEM INITIALIZED</div>
      <div class="log-line sys"><span class="ts">00:00:00</span>PERSISTENCE ENGINE ACTIVE</div>
    </div>

  </aside>

  <!-- VIEWER -->
  <main>
    <!-- Standby Visual -->
    <div id="standby-screen">
      <div class="standby-icon">⬢</div>
      <div class="standby-text">SYSTEM READY // AWAITING INPUT</div>
      <div class="standby-sub">Drag & Drop PDF or Click Load</div>
    </div>

    <!-- Drop Overlay -->
    <div id="drop-overlay">
      <div class="drop-msg">:: INITIATE DECRYPTION ::</div>
      <div class="drop-sub">Release to Load File</div>
    </div>
    
    <!-- Viewport -->
    <div id="viewport">
      <div id="page-wrapper" class="page-container" style="display:none;">
        <!-- Rulers attached to the page -->
        <div id="ruler-corner" class="ruler-corner">in</div>
        <div id="ruler-top" class="ruler top"></div>
        <div id="ruler-left" class="ruler left"></div>
        
        <!-- Main Canvas -->
        <canvas id="the-canvas"></canvas>
        
        <!-- Overlays -->
        <div id="layer-margins" class="layer"></div>
        <div id="layer-grid" class="layer"></div>
      </div>
    </div>
  </main>

</div>

<!-- FOOTER -->
<footer>
  <div class="flex-row">
    <span class="status-dot" id="status-led"></span>
    <span id="status-text">IDLE</span>
  </div>
  <div class="flex-row">
    <span class="text-xs text-mute">VER 4.0.0 // OMEGA PLATINUM</span>
  </div>
</footer>

<!-- HELP MODAL -->
<div id="modal-help" class="modal-backdrop">
  <div class="modal-panel">
    <div class="modal-header">
      <span class="modal-title">KEYBOARD COMMANDS</span>
      <button class="modal-close" onclick="UI.toggleHelp()">×</button>
    </div>
    <div class="modal-body">
      <div class="shortcut-row"><span>Toggle Sidebar</span> <span class="key-combo">Ctrl + B</span></div>
      <div class="shortcut-row"><span>Previous Page</span> <span class="key-combo">← Left</span></div>
      <div class="shortcut-row"><span>Next Page</span> <span class="key-combo">→ Right</span></div>
      <div class="shortcut-row"><span>Zoom In</span> <span class="key-combo">]</span></div>
      <div class="shortcut-row"><span>Zoom Out</span> <span class="key-combo">[</span></div>
      <div class="shortcut-row"><span>Toggle Grid</span> <span class="key-combo">G</span></div>
      <div class="shortcut-row"><span>Toggle Margins</span> <span class="key-combo">M</span></div>
      <div class="shortcut-row"><span>Reset View</span> <span class="key-combo">R</span></div>
    </div>
  </div>
</div>

<script>
/**
 * SRC-D // SHADEPROOF // OMEGA PLATINUM
 * 
 * Architecture:
 * - State: Persistent localStorage management
 * - PDFEngine: Rendering pipeline (pdf.js)
 * - StampEngine: Modification pipeline (pdf-lib)
 * - OverlayEngine: Rulers, Grids, Margins
 * - AnalysisEngine: Content-aware scanning
 * - InputManager: Keyboard/Mouse handling
 */

const PDF_LIB = window['pdfjs-dist/build/pdf'];
PDF_LIB.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// --- STATE MANAGEMENT ---
const State = {
  doc: null,
  fileBuffer: null, // Store raw buffer for stamping
  fileName: 'document.pdf',
  currentPage: 1,
  scale: 1.0,
  autoFit: true,
  sidebarOpen: true,
  gridOffset: 0,
  gridLines: 28,
  layers: { margin: true, grid: true, ruler: true },
  isBusy: false,
  
  // Stamping Data
  stamp: { case: '', title: '', atty: '' },

  // Persistence
  load() {
    const saved = localStorage.getItem('shadeproof_cfg_v4');
    if(saved) {
      const cfg = JSON.parse(saved);
      this.sidebarOpen = cfg.sidebarOpen ?? true;
      this.layers = { ...this.layers, ...cfg.layers };
      this.gridOffset = cfg.gridOffset ?? 0;
      this.gridLines = cfg.gridLines ?? 28;
    }
  },

  save() {
    const cfg = {
      sidebarOpen: this.sidebarOpen,
      layers: this.layers,
      gridOffset: this.gridOffset,
      gridLines: this.gridLines
    };
    localStorage.setItem('shadeproof_cfg_v4', JSON.stringify(cfg));
  }
};

// --- UI CONTROLLER ---
const UI = {
  els: {
    sidebar: document.getElementById('main-sidebar'),
    file: document.getElementById('inp-file'),
    drop: document.getElementById('drop-overlay'),
    standby: document.getElementById('standby-screen'),
    canvas: document.getElementById('the-canvas'),
    wrapper: document.getElementById('page-wrapper'),
    viewport: document.getElementById('viewport'),
    log: document.getElementById('console-output'),
    nav: document.getElementById('nav-group'),
    pageLbl: document.getElementById('lbl-page'),
    
    // Buttons
    btnLoadGroup: document.getElementById('btn-group-load'),
    btnCloseGroup: document.getElementById('btn-group-close'),
    
    // Layers
    rTop: document.getElementById('ruler-top'),
    rLeft: document.getElementById('ruler-left'),
    rCorner: document.getElementById('ruler-corner'),
    lMargin: document.getElementById('layer-margins'),
    lGrid: document.getElementById('layer-grid'),

    // Telemetry
    tDim: document.getElementById('tel-dim'),
    tOrient: document.getElementById('tel-orient'),
    tMargin: document.getElementById('tel-margin'),
    tCheck: document.getElementById('tel-check'),
    
    // Metadata
    mSize: document.getElementById('meta-size'),
    mVer: document.getElementById('meta-ver'),
    mProd: document.getElementById('meta-prod'),
    
    // Inputs
    inpCase: document.getElementById('inp-case'),
    inpTitle: document.getElementById('inp-title'),
    inpAtty: document.getElementById('inp-atty'),
    
    led: document.getElementById('status-led'),
    stat: document.getElementById('status-text'),
    modalHelp: document.getElementById('modal-help'),
    
    // Controls
    chkGrid: document.getElementById('chk-grid'),
    chkMargin: document.getElementById('chk-margin'),
    chkRuler: document.getElementById('chk-ruler'),
    rngZoom: document.getElementById('rng-zoom'),
    valZoom: document.getElementById('val-zoom'),
    rngOffset: document.getElementById('rng-offset'),
    valOffset: document.getElementById('val-offset'),
    rngDensity: document.getElementById('rng-density'),
    valDensity: document.getElementById('val-density')
  },

  init() {
    State.load();
    this.applyState();
    this.log('SYSTEM READY', 'sys');
    
    // Resize Observer for Auto-Fit adjustments
    const ro = new ResizeObserver(() => {
      if(State.doc && State.autoFit) render();
    });
    ro.observe(this.els.viewport);
  },

  applyState() {
    // Sidebar
    if(!State.sidebarOpen) this.els.sidebar.classList.add('collapsed');
    else this.els.sidebar.classList.remove('collapsed');

    // Checkboxes
    this.els.chkGrid.checked = State.layers.grid;
    this.els.chkMargin.checked = State.layers.margin;
    this.els.chkRuler.checked = State.layers.ruler;
    
    // Sliders
    this.els.rngOffset.value = State.gridOffset;
    this.els.valOffset.textContent = (State.gridOffset > 0 ? '+' : '') + State.gridOffset + 'px';
    this.els.rngDensity.value = State.gridLines;
    this.els.valDensity.textContent = State.gridLines + ' LINES';
  },

  log(msg, type = 'sys') {
    const div = document.createElement('div');
    div.className = `log-line ${type}`;
    const time = new Date().toLocaleTimeString('en-US', {hour12:false});
    div.innerHTML = `<span class="ts">${time}</span>${msg}`;
    this.els.log.appendChild(div);
    this.els.log.scrollTop = this.els.log.scrollHeight;
  },

  setStatus(msg, busy = false) {
    this.els.stat.textContent = msg;
    this.els.led.className = busy ? 'status-dot busy' : 'status-dot active';
  },

  enable() {
    this.els.nav.style.opacity = '1';
    this.els.nav.style.pointerEvents = 'auto';
    this.els.standby.style.display = 'none';
    this.els.wrapper.style.display = 'block';
    this.els.btnLoadGroup.classList.add('hidden');
    this.els.btnCloseGroup.classList.remove('hidden');
  },

  resetView() {
    this.els.nav.style.opacity = '0.3';
    this.els.nav.style.pointerEvents = 'none';
    this.els.standby.style.display = 'flex';
    this.els.wrapper.style.display = 'none';
    this.els.btnLoadGroup.classList.remove('hidden');
    this.els.btnCloseGroup.classList.add('hidden');
    this.els.file.value = ''; // Reset input
    
    // Reset Text
    this.els.tDim.textContent = '--';
    this.els.tOrient.textContent = '--';
    this.els.tMargin.textContent = '--';
    this.els.tCheck.textContent = 'WAITING';
    this.els.tCheck.className = 'data-val';
    this.els.mSize.textContent = '--';
    this.els.mVer.textContent = '--';
    this.els.mProd.textContent = '--';
    this.els.pageLbl.textContent = '-- / --';
    
    // Clear Canvas
    const ctx = this.els.canvas.getContext('2d');
    ctx.clearRect(0, 0, this.els.canvas.width, this.els.canvas.height);
  },

  toggleSidebar() {
    State.sidebarOpen = !State.sidebarOpen;
    this.applyState();
    State.save();
  },

  toggleHelp() {
    this.els.modalHelp.classList.toggle('active');
  }
};

// --- CORE LOGIC ---
async function loadFile(file) {
  if(!file) return;
  UI.log(`LOADING: ${file.name.toUpperCase()}`, 'sys');
  UI.setStatus('DECRYPTING...', true);
  
  // Metadata: Size
  const sizeMB = (file.size / (1024*1024)).toFixed(2);
  UI.els.mSize.textContent = `${sizeMB} MB`;

  try {
    State.fileBuffer = await file.arrayBuffer();
    State.fileName = file.name;
    if(State.doc) await State.doc.destroy();
    State.doc = await PDF_LIB.getDocument(State.fileBuffer).promise;
    
    // Metadata: Internal
    try {
      const metaData = await State.doc.getMetadata();
      UI.els.mVer.textContent = metaData.info.PDFFormatVersion || '1.4';
      UI.els.mProd.textContent = metaData.info.Producer || 'UNKNOWN';
      UI.els.mProd.title = metaData.info.Producer || ''; 
    } catch(e) { UI.els.mVer.textContent = 'N/A'; }

    State.currentPage = 1;
    State.autoFit = true; 
    
    UI.log(`LOADED ${State.doc.numPages} PAGES`, 'ok');
    UI.enable();
    render();
  } catch(err) {
    console.error(err);
    UI.log('FILE ERROR: CORRUPT OR ENCRYPTED', 'err');
    UI.setStatus('ERROR', false);
  }
}

async function closeDocument() {
  if(State.doc) {
    await State.doc.destroy();
    State.doc = null;
    State.fileBuffer = null;
  }
  UI.resetView();
  UI.log('SYSTEM RESET', 'sys');
  UI.setStatus('IDLE');
}

async function render() {
  if(!State.doc || State.isBusy) return;
  State.isBusy = true;
  UI.setStatus('RENDERING...', true);

  try {
    const page = await State.doc.getPage(State.currentPage);
    const unscaledVp = page.getViewport({scale: 1.0});
    
    // Auto-Fit Logic
    if(State.autoFit) {
      const availableH = UI.els.viewport.clientHeight - 120; 
      const fitScale = availableH / (unscaledVp.height * 1.33);
      State.scale = fitScale;
      State.autoFit = false; 
      
      UI.els.rngZoom.value = Math.round(State.scale * 100);
      UI.els.valZoom.textContent = Math.round(State.scale * 100) + '%';
    }

    const baseScale = 1.333; 
    const viewport = page.getViewport({ scale: baseScale * State.scale });
    const dpr = window.devicePixelRatio || 1;

    // Canvas Sizing
    const cvs = UI.els.canvas;
    const wrap = UI.els.wrapper;
    
    cvs.style.width = `${viewport.width}px`;
    cvs.style.height = `${viewport.height}px`;
    wrap.style.width = `${viewport.width}px`;
    wrap.style.height = `${viewport.height}px`;
    
    cvs.width = viewport.width * dpr;
    cvs.height = viewport.height * dpr;
    
    const ctx = cvs.getContext('2d');
    ctx.scale(dpr, dpr);

    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

    // --- RENDER FOOTER PREVIEW (VISUAL ONLY) ---
    drawFooterPreview(ctx, viewport.width, viewport.height);

    updateTelemetry(viewport);
    await analyzeContent(page);
    drawOverlays(viewport.width, viewport.height);

    UI.els.pageLbl.textContent = `${State.currentPage} / ${State.doc.numPages}`;
    UI.setStatus('READY', false);

  } catch(err) {
    console.error(err);
    UI.log(`RENDER ERROR PAGE ${State.currentPage}`, 'err');
  } finally {
    State.isBusy = false;
  }
}

// --- FOOTER PREVIEW LOGIC ---
function drawFooterPreview(ctx, w, h) {
  const caseNo = State.stamp.case;
  const title = State.stamp.title;
  const atty = State.stamp.atty;
  
  if(!caseNo && !title && !atty) return;

  // Scale font size relative to canvas width (approx 10pt at 96dpi)
  const fontSize = (w / 8.5) * 0.12; 
  ctx.font = `${fontSize}px "Courier New", monospace`;
  ctx.fillStyle = "#000";
  
  // Bottom Margin Position (approx 0.75 inch from bottom)
  const yPos = h - (h / 11) * 0.75;
  const leftX = (w / 8.5) * 1.0; // 1 inch margin
  const rightX = w - leftX;
  const centerX = w / 2;

  // Draw Left: Title
  if(title) ctx.fillText(title, leftX, yPos);
  
  // Draw Center: Page Number
  const pageTxt = `Page ${State.currentPage} of ${State.doc.numPages}`;
  const pWidth = ctx.measureText(pageTxt).width;
  ctx.fillText(pageTxt, centerX - (pWidth/2), yPos);

  // Draw Right: Case No
  if(caseNo) {
    const cWidth = ctx.measureText(caseNo).width;
    ctx.fillText(caseNo, rightX - cWidth, yPos);
  }

  // Draw Attorney Info (Below Footer)
  if(atty) {
    const attyY = yPos + (fontSize * 1.5);
    const aWidth = ctx.measureText(atty).width;
    ctx.fillText(atty, rightX - aWidth, attyY);
  }
}

// --- STAMPING & DOWNLOAD ENGINE (PDF-LIB) ---
async function stampAndDownload() {
  if(!State.fileBuffer) return;
  UI.log('INITIATING STAMPING SEQUENCE...', 'sys');
  UI.setStatus('STAMPING...', true);

  try {
    const { PDFDocument, StandardFonts, rgb } = PDFLib;
    const pdfDoc = await PDFDocument.load(State.fileBuffer);
    const font = await pdfDoc.embedFont(StandardFonts.Courier);
    const pages = pdfDoc.getPages();
    const total = pages.length;

    pages.forEach((page, idx) => {
      const { width, height } = page.getSize();
      const fontSize = 10;
      const yPos = 40; // Approx 0.55 inch from bottom
      const margin = 72; // 1 inch

      // Center: Page Number
      const pageText = `Page ${idx + 1} of ${total}`;
      const pWidth = font.widthOfTextAtSize(pageText, fontSize);
      page.drawText(pageText, { x: (width/2) - (pWidth/2), y: yPos, size: fontSize, font: font });

      // Left: Title
      if(State.stamp.title) {
        page.drawText(State.stamp.title, { x: margin, y: yPos, size: fontSize, font: font });
      }

      // Right: Case No
      if(State.stamp.case) {
        const cWidth = font.widthOfTextAtSize(State.stamp.case, fontSize);
        page.drawText(State.stamp.case, { x: width - margin - cWidth, y: yPos, size: fontSize, font: font });
      }

      // Right Below: Attorney
      if(State.stamp.atty) {
        const aWidth = font.widthOfTextAtSize(State.stamp.atty, fontSize);
        page.drawText(State.stamp.atty, { x: width - margin - aWidth, y: yPos - 12, size: fontSize, font: font });
      }
    });

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `STAMPED_${State.fileName}`;
    link.click();
    
    UI.log('FILE STAMPED & DOWNLOADED', 'ok');
    UI.setStatus('READY');

  } catch(err) {
    console.error(err);
    UI.log('STAMPING FAILED', 'err');
    UI.setStatus('ERROR');
  }
}

function updateTelemetry(vp) {
  const rawW = vp.width / State.scale;
  const rawH = vp.height / State.scale;
  const wIn = (rawW / 96).toFixed(2);
  const hIn = (rawH / 96).toFixed(2);

  UI.els.tDim.textContent = `${wIn}" x ${hIn}"`;
  UI.els.tOrient.textContent = hIn > wIn ? 'PORTRAIT' : 'LANDSCAPE';
  
  const isPg1 = State.currentPage === 1;
  UI.els.tMargin.textContent = isPg1 ? '3.0" (RULE 10d)' : '1.0" (STANDARD)';
  UI.els.tMargin.className = isPg1 ? 'data-val chk' : 'data-val ok';
}

async function analyzeContent(page) {
  UI.els.tCheck.textContent = 'SCANNING...';
  UI.els.tCheck.className = 'data-val';
  
  try {
    const textContent = await page.getTextContent();
    const rawVP = page.getViewport({scale: 1.0});
    const topMarginPts = State.currentPage === 1 ? 216 : 72;
    const safetyY = rawVP.height - topMarginPts;
    
    let issue = false;
    let issueType = '';

    for(const item of textContent.items) {
      const y = item.transform[5];
      const x = item.transform[4];
      const str = item.str.trim();
      
      if(str.length === 0) continue;

      // Check Top Margin
      if(y > safetyY) {
        issue = true; issueType = 'TOP MARGIN'; break;
      }
      
      // Check Left Margin (Line Numbers Zone - approx 0.75 inch)
      if(x < 50) {
        if(isNaN(parseInt(str))) {
          issue = true; issueType = 'LEFT MARGIN'; break;
        }
      }
    }

    if(issue) {
      UI.els.tCheck.textContent = 'GUIDANCE NEEDED';
      UI.els.tCheck.className = 'data-val chk';
      UI.log(`PAGE ${State.currentPage}: ${issueType} intrusion detected.`, 'guide');
    } else {
      UI.els.tCheck.textContent = 'CLEAR';
      UI.els.tCheck.className = 'data-val ok';
    }
  } catch(e) { console.error(e); }
}

function drawOverlays(w, h) {
  const { rTop, rLeft, rCorner, lMargin, lGrid } = UI.els;
  rTop.innerHTML = ''; rLeft.innerHTML = ''; lMargin.innerHTML = ''; lGrid.innerHTML = '';

  // Toggle Visibility based on State
  rTop.style.display = State.layers.ruler ? 'block' : 'none';
  rLeft.style.display = State.layers.ruler ? 'block' : 'none';
  rCorner.style.display = State.layers.ruler ? 'flex' : 'none';

  const inch = 96 * State.scale;

  // --- RULER GENERATOR ---
  // Top Ruler (X)
  const widthInches = Math.ceil(w / inch);
  for(let i=0; i<=widthInches; i++) {
    createTick(rTop, i*inch, 0, 1, 12, i, true); // Major
    if(i < widthInches) {
      createTick(rTop, (i+0.5)*inch, 0, 1, 8, null, true); // Half
      createTick(rTop, (i+0.25)*inch, 0, 1, 5, null, true); // Quarter
      createTick(rTop, (i+0.75)*inch, 0, 1, 5, null, true); // Quarter
    }
  }

  // Left Ruler (Y)
  const heightInches = Math.ceil(h / inch);
  for(let i=0; i<=heightInches; i++) {
    createTick(rLeft, 0, i*inch, 12, 1, i, false); // Major
    if(i < heightInches) {
      createTick(rLeft, 0, (i+0.5)*inch, 8, 1, null, false); // Half
      createTick(rLeft, 0, (i+0.25)*inch, 5, 1, null, false); // Quarter
      createTick(rLeft, 0, (i+0.75)*inch, 5, 1, null, false); // Quarter
    }
  }

  // --- MARGINS ---
  if(State.layers.margin) {
    const topM = (State.currentPage === 1 ? 3 : 1) * inch;
    const sideM = 1 * inch;
    const botM = 1 * inch;
    const isFlagged = UI.els.tCheck.textContent === 'GUIDANCE NEEDED';
    
    const box = document.createElement('div');
    box.className = isFlagged ? 'margin-zone guidance-needed' : 'margin-zone';
    box.style.top = topM + 'px'; box.style.left = sideM + 'px';
    box.style.width = (w - (sideM * 2)) + 'px'; box.style.height = (h - topM - botM) + 'px';
    lMargin.appendChild(box);
  }

  // --- GRID ---
  if(State.layers.grid) {
    const topM = (State.currentPage === 1 ? 3 : 1) * inch;
    const botM = 1 * inch;
    const textAreaH = h - topM - botM;
    const count = State.gridLines;
    const lineHeight = textAreaH / count;
    const offset = State.gridOffset * State.scale;

    for(let i=0; i<=count; i++) {
      let line = document.createElement('div');
      line.className = (i===0 || i===count) ? 'grid-line major' : 'grid-line';
      line.style.top = (topM + (i * lineHeight) + offset) + 'px';
      lGrid.appendChild(line);
    }
  }
}

function createTick(parent, x, y, w, h, label, isTop) {
  const t = document.createElement('div');
  t.className = 'tick';
  t.style.left = x + 'px'; t.style.top = y + 'px';
  t.style.width = w + 'px'; t.style.height = h + 'px';
  
  if(isTop) t.style.bottom = '0'; else t.style.right = '0';
  parent.appendChild(t);

  if(label !== null) {
    const l = document.createElement('div');
    l.className = 'tick-lbl';
    l.textContent = label;
    if(isTop) { l.style.left = (x + 3) + 'px'; l.style.top = '2px'; }
    else { l.style.top = (y + 3) + 'px'; l.style.left = '2px'; }
    parent.appendChild(l);
  }
}

// --- EVENT LISTENERS ---
UI.init();

document.getElementById('btn-toggle-sidebar').onclick = () => UI.toggleSidebar();
document.getElementById('btn-help').onclick = () => UI.toggleHelp();
document.getElementById('btn-close').onclick = () => closeDocument();

UI.els.file.onchange = (e) => loadFile(e.target.files[0]);

// Drag & Drop
document.body.ondragover = (e) => { e.preventDefault(); UI.els.drop.classList.add('active'); };
document.body.ondragleave = (e) => { if(!e.relatedTarget) UI.els.drop.classList.remove('active'); };
document.body.ondrop = (e) => {
  e.preventDefault(); UI.els.drop.classList.remove('active');
  if(e.dataTransfer.files[0]?.type === 'application/pdf') loadFile(e.dataTransfer.files[0]);
};

// Navigation
document.getElementById('btn-prev').onclick = () => { if(State.currentPage > 1) { State.currentPage--; render(); }};
document.getElementById('btn-next').onclick = () => { if(State.doc && State.currentPage < State.doc.numPages) { State.currentPage++; render(); }};

// Controls
UI.els.rngZoom.oninput = (e) => {
  State.scale = parseInt(e.target.value) / 100;
  UI.els.valZoom.textContent = e.target.value + '%';
  render();
};

UI.els.rngOffset.oninput = (e) => {
  State.gridOffset = parseInt(e.target.value);
  UI.els.valOffset.textContent = (State.gridOffset > 0 ? '+' : '') + State.gridOffset + 'px';
  State.save();
  // Fast redraw
  const cvs = UI.els.canvas;
  drawOverlays(parseFloat(cvs.style.width), parseFloat(cvs.style.height));
};

document.getElementById('btn-rst-grid').onclick = () => {
  State.gridOffset = 0;
  UI.els.rngOffset.value = 0;
  UI.els.valOffset.textContent = '0px';
  State.save();
  const cvs = UI.els.canvas;
  drawOverlays(parseFloat(cvs.style.width), parseFloat(cvs.style.height));
};

UI.els.rngDensity.oninput = (e) => {
  State.gridLines = parseInt(e.target.value);
  UI.els.valDensity.textContent = State.gridLines + ' LINES';
  State.save();
  const cvs = UI.els.canvas;
  drawOverlays(parseFloat(cvs.style.width), parseFloat(cvs.style.height));
};

UI.els.chkGrid.onchange = (e) => { State.layers.grid = e.target.checked; State.save(); render(); };
UI.els.chkMargin.onchange = (e) => { State.layers.margin = e.target.checked; State.save(); render(); };
UI.els.chkRuler.onchange = (e) => { State.layers.ruler = e.target.checked; State.save(); render(); };

// Stamping Inputs
const updateStamp = () => {
  State.stamp.case = UI.els.inpCase.value;
  State.stamp.title = UI.els.inpTitle.value;
  State.stamp.atty = UI.els.inpAtty.value;
  render(); // Re-render to show preview
};
UI.els.inpCase.oninput = updateStamp;
UI.els.inpTitle.oninput = updateStamp;
UI.els.inpAtty.oninput = updateStamp;
document.getElementById('btn-stamp').onclick = stampAndDownload;

// Keyboard Shortcuts
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') UI.els.modalHelp.classList.remove('active');
  if(e.key === '?') UI.toggleHelp();
  if(e.ctrlKey && e.key === 'b') { e.preventDefault(); UI.toggleSidebar(); }
  
  if(!State.doc) return;
  if(e.key === 'ArrowLeft') document.getElementById('btn-prev').click();
  if(e.key === 'ArrowRight') document.getElementById('btn-next').click();
  if(e.key === ']') { UI.els.rngZoom.value = Math.min(200, parseInt(UI.els.rngZoom.value)+10); UI.els.rngZoom.dispatchEvent(new Event('input')); }
  if(e.key === '[') { UI.els.rngZoom.value = Math.max(25, parseInt(UI.els.rngZoom.value)-10); UI.els.rngZoom.dispatchEvent(new Event('input')); }
  if(e.key.toLowerCase() === 'g') UI.els.chkGrid.click();
  if(e.key.toLowerCase() === 'm') UI.els.chkMargin.click();
  if(e.key.toLowerCase() === 'r') { State.autoFit = true; render(); }
});

</script>
</body>
</html>
