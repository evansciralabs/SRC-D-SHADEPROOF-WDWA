<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SRC-D // SHADEPROOF // HUB</title>

<!-- PDF.js Core & Worker (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>

<style>
/* 
   ==========================================================================
   SRC-D // DESIGN SYSTEM // FINAL RELEASE
   ==========================================================================
*/

:root {
  /* --- PALETTE: DEEP SPACE --- */
  --bg-void:    #05070a;
  --bg-panel:   #0d1117;
  --bg-input:   #161b22;
  
  /* --- PALETTE: INTERFACE --- */
  --border:     #30363d;
  --border-hl:  #58a6ff;
  --text-main:  #c9d1d9;
  --text-mute:  #8b949e;
  
  /* --- PALETTE: STATUS --- */
  --accent:     #3d5afe; 
  --status-ok:  #238636; 
  --status-chk: #d29922; 
  --status-err: #f85149; 

  /* --- DIMENSIONS --- */
  --sidebar-w:  380px;
  --header-h:   54px;
  --footer-h:   28px;
  
  /* --- TYPOGRAPHY --- */
  --font-mono: 'JetBrains Mono', 'SF Mono', 'Segoe UI Mono', 'Courier New', monospace;
}

/* --- GLOBAL RESET --- */
* { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
body {
  margin: 0; padding: 0;
  background-color: var(--bg-void);
  color: var(--text-main);
  font-family: var(--font-mono);
  font-size: 12px;
  height: 100vh; width: 100vw;
  overflow: hidden;
  display: flex; flex-direction: column;
}

/* --- SCROLLBARS --- */
::-webkit-scrollbar { width: 8px; height: 8px; background: var(--bg-void); }
::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #58a6ff; }

/* --- UTILITY CLASSES --- */
.hidden { display: none !important; }
.flex-row { display: flex; align-items: center; gap: 8px; }
.flex-col { display: flex; flex-direction: column; gap: 8px; }
.text-xs { font-size: 10px; letter-spacing: 0.5px; }
.text-hl { color: var(--border-hl); }
.mono-bold { font-weight: 700; }
.w-full { width: 100%; }

/* --- HEADER --- */
header {
  height: var(--header-h);
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.brand-container { display: flex; flex-direction: column; line-height: 1.1; }
.brand-main { font-weight: 800; font-size: 14px; letter-spacing: 1.5px; color: var(--text-main); }
.brand-sub { font-size: 9px; color: var(--text-mute); letter-spacing: 1px; }

.header-tools { display: flex; gap: 12px; align-items: center; }

/* --- BUTTONS & INPUTS --- */
button.btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-main);
  padding: 6px 14px;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
button.btn:hover { border-color: var(--text-mute); background: #21262d; }
button.btn:active { border-color: var(--border-hl); color: var(--border-hl); }
button.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* --- MAIN LAYOUT --- */
#layout-grid {
  display: flex;
  height: calc(100vh - var(--header-h) - var(--footer-h));
  width: 100vw;
}

/* --- SIDEBAR --- */
aside {
  width: var(--sidebar-w);
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow-y: auto;
  flex-shrink: 0;
}

.panel-block {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.panel-title {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-mute);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
  display: flex; justify-content: space-between; align-items: center;
}

/* --- RESOURCE HUB LINKS --- */
.hub-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

a.hub-link {
  display: flex; flex-direction: column;
  background: #12161c;
  border: 1px solid var(--border);
  padding: 8px;
  text-decoration: none;
  border-radius: 4px;
  transition: all 0.2s;
}
a.hub-link:hover {
  border-color: var(--border-hl);
  background: #1c2128;
  transform: translateY(-1px);
}
.hub-link-title { font-size: 10px; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
.hub-link-sub { font-size: 9px; color: var(--text-mute); }
.hub-icon { color: var(--border-hl); font-size: 10px; margin-bottom: 4px; }

/* Data Grid Display */
.data-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px 8px;
}
.data-item { display: flex; flex-direction: column; gap: 2px; }
.data-lbl { font-size: 9px; color: var(--text-mute); }
.data-val { font-size: 11px; font-weight: 600; color: var(--text-main); }
.data-val.ok { color: var(--status-ok); }
.data-val.chk { color: var(--status-chk); }

/* Sliders */
.slider-row { display: flex; align-items: center; gap: 10px; font-size: 10px; margin-bottom: 8px; }
input[type="range"] {
  flex: 1; -webkit-appearance: none; background: transparent;
}
input[type="range"]::-webkit-slider-runnable-track {
  width: 100%; height: 4px; background: var(--border); border-radius: 2px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
  background: var(--text-main); margin-top: -4px; cursor: pointer;
}

/* Checkboxes */
.chk-row {
  display: flex; align-items: center; gap: 10px;
  padding: 4px 0; cursor: pointer; color: var(--text-mute);
  transition: color 0.2s;
}
.chk-row:hover { color: var(--text-main); }
.chk-row input { accent-color: var(--border-hl); }

/* System Log */
#console-output {
  flex: 1;
  background: #000;
  padding: 12px;
  font-family: 'Courier New', monospace;
  font-size: 10px;
  line-height: 1.4;
  overflow-y: auto;
  border-top: 1px solid var(--border);
  min-height: 150px;
}
.log-line { margin-bottom: 4px; border-left: 2px solid transparent; padding-left: 6px; }
.log-line.sys { color: var(--text-mute); border-color: var(--border); }
.log-line.ok { color: var(--status-ok); border-color: var(--status-ok); }
.log-line.guide { color: var(--status-chk); border-color: var(--status-chk); }
.log-line.err { color: var(--status-err); border-color: var(--status-err); }
.ts { color: #444; margin-right: 6px; user-select: none; }

/* --- VIEWER STAGE --- */
main {
  flex: 1;
  background: #090c10;
  position: relative;
  overflow: hidden;
  display: flex; flex-direction: column;
}

/* Standby Screen (The "Empty State" Fix) */
#standby-screen {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  color: var(--text-mute);
  z-index: 10;
  pointer-events: none;
}
.standby-icon { font-size: 48px; color: #1c2128; margin-bottom: 20px; text-shadow: 0 0 20px rgba(61, 90, 254, 0.1); }
.standby-text { font-size: 14px; letter-spacing: 2px; font-weight: 700; color: #30363d; }

/* Drop Zone */
#drop-overlay {
  position: absolute; inset: 0;
  background: rgba(13, 17, 23, 0.9);
  backdrop-filter: blur(4px);
  z-index: 500;
  display: flex; align-items: center; justify-content: center;
  border: 2px dashed var(--border-hl);
  color: var(--border-hl);
  font-size: 14px; letter-spacing: 2px; font-weight: 700;
}

/* Canvas Wrapper */
#viewport {
  flex: 1; overflow: auto;
  display: flex; justify-content: center;
  padding: 60px;
  /* Technical Grid Background */
  background-image: 
    linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 20px 20px;
}

.page-container {
  position: relative;
  background: #fff;
  box-shadow: 0 0 80px rgba(0,0,0,0.8);
  transition: transform 0.1s linear;
}

canvas { display: block; }

/* --- OVERLAYS --- */
.layer { position: absolute; inset: 0; pointer-events: none; }

/* Rulers */
.ruler-h { position: absolute; top: 0; left: 0; right: 0; height: 20px; background: rgba(255,255,255,0.96); border-bottom: 1px solid #999; z-index: 20; }
.ruler-v { position: absolute; top: 0; left: 0; bottom: 0; width: 20px; background: rgba(255,255,255,0.96); border-right: 1px solid #999; z-index: 20; }
.tick-mark { position: absolute; background: #444; }
.tick-text { position: absolute; font-size: 8px; color: #222; font-family: sans-serif; }

/* Margin Box (Procedural Feedback) */
.margin-zone {
  position: absolute;
  border: 2px dashed rgba(61, 90, 254, 0.4);
  background: rgba(61, 90, 254, 0.02);
  z-index: 10;
  transition: all 0.4s ease;
}
.margin-zone.guidance-needed {
  border-color: var(--status-chk);
  background: rgba(210, 153, 34, 0.1);
}

/* Grid Lines */
.grid-line { position: absolute; width: 100%; border-top: 1px solid rgba(0, 230, 118, 0.25); }
.grid-line.major { border-color: rgba(0, 230, 118, 0.6); }

/* --- FOOTER --- */
footer {
  height: var(--footer-h);
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 15px;
  font-size: 10px; color: var(--text-mute);
  z-index: 100;
}
.status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #444; margin-right: 6px; }
.status-dot.active { background: var(--status-ok); box-shadow: 0 0 8px var(--status-ok); }
.status-dot.busy { background: var(--status-chk); animation: pulse 1s infinite; }

@keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="brand-container">
    <span class="brand-main">SRC-D // SHADEPROOF</span>
    <span class="brand-sub">UTILITY HUB // WDWA PROTOCOL</span>
  </div>
  
  <div class="header-tools">
    <input type="file" id="inp-file" accept=".pdf" class="hidden">
    <button class="btn" onclick="document.getElementById('inp-file').click()">Load PDF</button>
    
    <div class="flex-row" id="nav-group" style="opacity: 0.3; pointer-events: none;">
      <button class="btn" id="btn-prev">Prev</button>
      <span id="lbl-page" class="mono-bold" style="min-width: 60px; text-align: center;">-- / --</span>
      <button class="btn" id="btn-next">Next</button>
    </div>
  </div>
</header>

<!-- MAIN LAYOUT -->
<div id="layout-grid">
  
  <!-- SIDEBAR -->
  <aside>
    
    <!-- 1. EXTERNAL UPLINKS (THE HUB) -->
    <div class="panel-block">
      <div class="panel-title"><span>External Uplinks (WDWA)</span></div>
      <div class="hub-grid">
        <a href="https://www.uscourts.gov/forms/civil-forms/civil-cover-sheet" target="_blank" class="hub-link">
          <span class="hub-icon">⬇</span>
          <span class="hub-link-title">JS-44 FORM</span>
          <span class="hub-link-sub">Civil Cover Sheet</span>
        </a>
        <a href="https://www.uscourts.gov/forms/civil-forms/summons-civil-action" target="_blank" class="hub-link">
          <span class="hub-icon">⬇</span>
          <span class="hub-link-title">AO-440 FORM</span>
          <span class="hub-link-sub">Summons</span>
        </a>
        <a href="https://www.wawd.uscourts.gov/local-rules-and-orders" target="_blank" class="hub-link">
          <span class="hub-icon">↗</span>
          <span class="hub-link-title">LOCAL RULES</span>
          <span class="hub-link-sub">LCR Reference</span>
        </a>
        <a href="https://ecf.wawd.uscourts.gov/" target="_blank" class="hub-link">
          <span class="hub-icon">↗</span>
          <span class="hub-link-title">ECF PORTAL</span>
          <span class="hub-link-sub">Filing System</span>
        </a>
      </div>
    </div>

    <!-- 2. TELEMETRY -->
    <div class="panel-block">
      <div class="panel-title"><span>Page Telemetry</span></div>
      <div class="data-grid">
        <div class="data-item">
          <span class="data-lbl">DIMENSIONS</span>
          <span class="data-val" id="tel-dim">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">ORIENTATION</span>
          <span class="data-val" id="tel-orient">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">TOP MARGIN (RULE 10d)</span>
          <span class="data-val" id="tel-margin">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">CONTENT CHECK</span>
          <span class="data-val" id="tel-check">WAITING</span>
        </div>
      </div>
    </div>

    <!-- 3. METADATA -->
    <div class="panel-block">
      <div class="panel-title"><span>File Metadata</span></div>
      <div class="data-grid">
        <div class="data-item">
          <span class="data-lbl">FILE SIZE</span>
          <span class="data-val" id="meta-size">--</span>
        </div>
        <div class="data-item">
          <span class="data-lbl">PDF VERSION</span>
          <span class="data-val" id="meta-ver">--</span>
        </div>
        <div class="data-item" style="grid-column: span 2;">
          <span class="data-lbl">PRODUCER</span>
          <span class="data-val" id="meta-prod" style="font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">--</span>
        </div>
      </div>
    </div>

    <!-- 4. OPTICS & CALIBRATION -->
    <div class="panel-block">
      <div class="panel-title"><span>Optical Calibration</span></div>
      
      <div class="flex-col">
        <div class="slider-row">
          <span class="text-xs w-full">ZOOM: <span id="val-zoom" class="text-hl">100%</span></span>
        </div>
        <div class="slider-row">
          <span>-</span>
          <input type="range" id="rng-zoom" min="50" max="250" value="100" step="10">
          <span>+</span>
        </div>

        <div class="slider-row" style="margin-top: 8px;">
          <span class="text-xs w-full">GRID Y-OFFSET: <span id="val-offset" class="text-hl">0px</span></span>
          <button class="btn" id="btn-rst-grid" style="padding: 2px 6px; font-size: 9px;">RESET</button>
        </div>
        <div class="slider-row">
          <input type="range" id="rng-offset" min="-30" max="30" value="0">
        </div>

        <div class="slider-row" style="margin-top: 8px;">
          <span class="text-xs w-full">GRID DENSITY: <span id="val-density" class="text-hl">28 LINES</span></span>
        </div>
        <div class="slider-row">
          <input type="range" id="rng-density" min="24" max="32" value="28" step="1">
        </div>
      </div>
    </div>

    <!-- 5. LAYERS -->
    <div class="panel-block">
      <div class="panel-title"><span>Visual Layers</span></div>
      <label class="chk-row"><input type="checkbox" id="chk-ruler" checked> <span>Metric Rulers (Inches)</span></label>
      <label class="chk-row"><input type="checkbox" id="chk-margin" checked> <span>Safety Zone Overlay</span></label>
      <label class="chk-row"><input type="checkbox" id="chk-grid" checked> <span>Line Grid System</span></label>
    </div>

    <!-- 6. SYSTEM LOG -->
    <div id="console-output">
      <div class="log-line sys"><span class="ts">00:00:00</span>SYSTEM INITIALIZED // HUB ACTIVE</div>
      <div class="log-line sys"><span class="ts">00:00:00</span>UPLINKS ESTABLISHED TO WAWD.USCOURTS.GOV</div>
    </div>

  </aside>

  <!-- VIEWER -->
  <main>
    <!-- Standby Visual -->
    <div id="standby-screen">
      <div class="standby-icon">⬢</div>
      <div class="standby-text">SYSTEM READY // AWAITING INPUT</div>
    </div>

    <div id="drop-overlay" class="hidden">:: DROP FILE TO INITIATE DECRYPTION ::</div>
    
    <div id="viewport">
      <div id="page-wrapper" class="page-container" style="display:none;">
        <canvas id="the-canvas"></canvas>
        <!-- Overlays -->
        <div id="layer-rulers" class="layer"></div>
        <div id="layer-margins" class="layer"></div>
        <div id="layer-grid" class="layer"></div>
      </div>
    </div>
  </main>

</div>

<!-- FOOTER -->
<footer>
  <div class="flex-row">
    <span class="status-dot" id="status-led"></span>
    <span id="status-text">IDLE</span>
  </div>
  <div class="text-xs text-mute">EVANSCIRA LABS // SECURE</div>
</footer>

<script>
/**
 * SRC-D // SHADEPROOF // HUB EDITION
 */

// --- CONFIGURATION ---
const PDF_LIB = window['pdfjs-dist/build/pdf'];
PDF_LIB.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// --- SYSTEM STATE ---
const System = {
  doc: null,
  meta: null,
  currentPage: 1,
  scale: 1.0,
  gridOffset: 0,
  gridLines: 28,
  layers: { ruler: true, margin: true, grid: true },
  isBusy: false
};

// --- UI CONTROLLER ---
const UI = {
  els: {
    file: document.getElementById('inp-file'),
    drop: document.getElementById('drop-overlay'),
    standby: document.getElementById('standby-screen'),
    canvas: document.getElementById('the-canvas'),
    wrapper: document.getElementById('page-wrapper'),
    log: document.getElementById('console-output'),
    nav: document.getElementById('nav-group'),
    pageLbl: document.getElementById('lbl-page'),
    
    // Layers
    lRuler: document.getElementById('layer-rulers'),
    lMargin: document.getElementById('layer-margins'),
    lGrid: document.getElementById('layer-grid'),

    // Telemetry
    tDim: document.getElementById('tel-dim'),
    tOrient: document.getElementById('tel-orient'),
    tMargin: document.getElementById('tel-margin'),
    tCheck: document.getElementById('tel-check'),
    
    // Metadata
    mSize: document.getElementById('meta-size'),
    mVer: document.getElementById('meta-ver'),
    mProd: document.getElementById('meta-prod'),

    // Status
    led: document.getElementById('status-led'),
    stat: document.getElementById('status-text')
  },

  log(msg, type = 'sys') {
    const div = document.createElement('div');
    div.className = `log-line ${type}`;
    const time = new Date().toLocaleTimeString('en-US', {hour12:false});
    div.innerHTML = `<span class="ts">${time}</span>${msg}`;
    this.els.log.appendChild(div);
    this.els.log.scrollTop = this.els.log.scrollHeight;
  },

  setStatus(msg, busy = false) {
    this.els.stat.textContent = msg;
    this.els.led.className = busy ? 'status-dot busy' : 'status-dot active';
  },

  reset() {
    this.els.nav.style.opacity = '0.3';
    this.els.nav.style.pointerEvents = 'none';
    this.els.tCheck.textContent = 'WAITING';
    this.els.tCheck.className = 'data-val';
  },

  enable() {
    this.els.nav.style.opacity = '1';
    this.els.nav.style.pointerEvents = 'auto';
    this.els.standby.style.display = 'none'; // Hide standby screen
    this.els.wrapper.style.display = 'block'; // Show canvas wrapper
  }
};

// --- CORE LOGIC ---
async function loadFile(file) {
  if(!file) return;
  
  UI.log(`INITIATING STREAM: ${file.name.toUpperCase()}`, 'sys');
  UI.setStatus('DECRYPTING...', true);
  
  // Metadata: Size
  const sizeMB = (file.size / (1024*1024)).toFixed(2);
  UI.els.mSize.textContent = `${sizeMB} MB`;

  try {
    const buffer = await file.arrayBuffer();
    if(System.doc) await System.doc.destroy();
    
    System.doc = await PDF_LIB.getDocument(buffer).promise;
    
    // Metadata: Internal
    try {
      const metaData = await System.doc.getMetadata();
      UI.els.mVer.textContent = metaData.info.PDFFormatVersion || '1.4';
      UI.els.mProd.textContent = metaData.info.Producer || 'UNKNOWN';
      UI.els.mProd.title = metaData.info.Producer || ''; // Tooltip
    } catch(e) {
      UI.els.mVer.textContent = 'N/A';
    }

    System.currentPage = 1;
    UI.log(`LOAD SUCCESS. PAGES: ${System.doc.numPages}`, 'ok');
    UI.enable();
    render();

  } catch(err) {
    console.error(err);
    UI.log('FATAL: FILE CORRUPT OR ENCRYPTED', 'err');
    UI.setStatus('ERROR', false);
  }
}

async function render() {
  if(!System.doc || System.isBusy) return;
  System.isBusy = true;
  UI.setStatus('RENDERING...', true);

  try {
    const page = await System.doc.getPage(System.currentPage);
    
    // 1. Viewport Calculation
    const baseScale = 1.333; // Approx 96 DPI
    const viewport = page.getViewport({ scale: baseScale * System.scale });
    const dpr = window.devicePixelRatio || 1;

    // 2. Canvas Sizing
    const cvs = UI.els.canvas;
    const wrap = UI.els.wrapper;
    
    cvs.style.width = `${viewport.width}px`;
    cvs.style.height = `${viewport.height}px`;
    wrap.style.width = `${viewport.width}px`;
    wrap.style.height = `${viewport.height}px`;
    
    cvs.width = viewport.width * dpr;
    cvs.height = viewport.height * dpr;
    
    const ctx = cvs.getContext('2d');
    ctx.scale(dpr, dpr);

    // 3. Draw PDF
    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

    // 4. Update Telemetry
    updateTelemetry(viewport);

    // 5. Procedural Analysis (Content Aware)
    await analyzeContent(page);

    // 6. Draw Overlays
    drawOverlays(viewport.width, viewport.height);

    // 7. Finalize
    UI.els.pageLbl.textContent = `${System.currentPage} / ${System.doc.numPages}`;
    UI.setStatus('READY', false);

  } catch(err) {
    UI.log(`RENDER ERROR: PAGE ${System.currentPage}`, 'err');
    console.error(err);
  } finally {
    System.isBusy = false;
  }
}

function updateTelemetry(vp) {
  const rawW = vp.width / System.scale;
  const rawH = vp.height / System.scale;
  const wIn = (rawW / 96).toFixed(2);
  const hIn = (rawH / 96).toFixed(2);

  UI.els.tDim.textContent = `${wIn}" x ${hIn}"`;
  UI.els.tOrient.textContent = hIn > wIn ? 'PORTRAIT' : 'LANDSCAPE';
  
  const isPg1 = System.currentPage === 1;
  UI.els.tMargin.textContent = isPg1 ? '3.0" (RULE 10d)' : '1.0" (STANDARD)';
  UI.els.tMargin.className = isPg1 ? 'data-val chk' : 'data-val ok';
}

// --- PROCEDURAL ANALYSIS ENGINE ---
async function analyzeContent(page) {
  UI.els.tCheck.textContent = 'SCANNING...';
  UI.els.tCheck.className = 'data-val';
  
  try {
    const textContent = await page.getTextContent();
    const rawVP = page.getViewport({scale: 1.0});
    
    // Thresholds (Points)
    const topMarginPts = System.currentPage === 1 ? 216 : 72; // 3" vs 1"
    const safetyY = rawVP.height - topMarginPts;
    
    let issues = [];

    for(const item of textContent.items) {
      // item.transform[5] is Y coordinate (0 at bottom)
      const y = item.transform[5];
      const str = item.str.trim();
      
      if(y > safetyY && str.length > 0) {
        // We found text in the top margin
        issues.push(`Text detected at y=${Math.round(y)}pt (Limit: ${safetyY}pt)`);
        break; // Stop after first detection for efficiency
      }
    }

    if(issues.length > 0) {
      UI.els.tCheck.textContent = 'GUIDANCE NEEDED';
      UI.els.tCheck.className = 'data-val chk';
      UI.log(`PAGE ${System.currentPage}: Content detected in top margin.`, 'guide');
      UI.log(`> ${issues[0]}`, 'guide');
      return true; // Issue found
    } else {
      UI.els.tCheck.textContent = 'CLEAR';
      UI.els.tCheck.className = 'data-val ok';
      return false;
    }

  } catch(e) {
    console.error(e);
    UI.els.tCheck.textContent = 'SCAN ERROR';
  }
  return false;
}

// --- OVERLAY ENGINE ---
function drawOverlays(w, h) {
  const { lRuler, lMargin, lGrid } = UI.els;
  lRuler.innerHTML = ''; lMargin.innerHTML = ''; lGrid.innerHTML = '';

  const inch = 96 * System.scale;

  // 1. Rulers
  if(System.layers.ruler) {
    // Horizontal
    for(let i=0; i<=w/inch; i++) {
      let t = document.createElement('div'); t.className='tick-mark';
      t.style.left=(i*inch)+'px'; t.style.top='0'; t.style.width='1px'; t.style.height='6px';
      let l = document.createElement('div'); l.className='tick-text';
      l.textContent=i; l.style.left=(i*inch+3)+'px'; l.style.top='6px';
      lRuler.appendChild(t); lRuler.appendChild(l);
    }
    // Vertical
    for(let i=0; i<=h/inch; i++) {
      let t = document.createElement('div'); t.className='tick-mark';
      t.style.top=(i*inch)+'px'; t.style.left='0'; t.style.height='1px'; t.style.width='6px';
      let l = document.createElement('div'); l.className='tick-text';
      l.textContent=i; l.style.top=(i*inch+3)+'px'; l.style.left='6px';
      lRuler.appendChild(t); lRuler.appendChild(l);
    }
  }

  // 2. Margin Zone (Procedural Feedback)
  if(System.layers.margin) {
    const topM = (System.currentPage === 1 ? 3 : 1) * inch;
    const sideM = 1 * inch;
    const botM = 1 * inch;
    
    const box = document.createElement('div');
    // Check if analysis flagged this page (we check UI text content for state)
    const isFlagged = UI.els.tCheck.textContent === 'GUIDANCE NEEDED';
    
    box.className = isFlagged ? 'margin-zone guidance-needed' : 'margin-zone';
    box.style.top = topM + 'px';
    box.style.left = sideM + 'px';
    box.style.width = (w - (sideM * 2)) + 'px';
    box.style.height = (h - topM - botM) + 'px';
    lMargin.appendChild(box);
  }

  // 3. Grid
  if(System.layers.grid) {
    const topM = (System.currentPage === 1 ? 3 : 1) * inch;
    const botM = 1 * inch;
    const textAreaH = h - topM - botM;
    const count = System.gridLines;
    const lineHeight = textAreaH / count;
    const offset = System.gridOffset * System.scale;

    for(let i=0; i<=count; i++) {
      let line = document.createElement('div');
      line.className = (i===0 || i===count) ? 'grid-line major' : 'grid-line';
      line.style.top = (topM + (i * lineHeight) + offset) + 'px';
      lGrid.appendChild(line);
    }
  }
}

// --- EVENT LISTENERS ---

// File Inputs
UI.els.file.onchange = (e) => loadFile(e.target.files[0]);

// Drag & Drop
document.body.ondragover = (e) => { e.preventDefault(); UI.els.drop.classList.remove('hidden'); };
document.body.ondragleave = (e) => { if(!e.relatedTarget) UI.els.drop.classList.add('hidden'); };
document.body.ondrop = (e) => {
  e.preventDefault();
  UI.els.drop.classList.add('hidden');
  if(e.dataTransfer.files[0]?.type === 'application/pdf') loadFile(e.dataTransfer.files[0]);
  else UI.log('INVALID FILE TYPE', 'err');
};

// Navigation
document.getElementById('btn-prev').onclick = () => { if(System.currentPage > 1) { System.currentPage--; render(); }};
document.getElementById('btn-next').onclick = () => { if(System.doc && System.currentPage < System.doc.numPages) { System.currentPage++; render(); }};

// Sliders
document.getElementById('rng-zoom').oninput = (e) => {
  System.scale = parseInt(e.target.value) / 100;
  document.getElementById('val-zoom').textContent = e.target.value + '%';
  render();
};

document.getElementById('rng-offset').oninput = (e) => {
  System.gridOffset = parseInt(e.target.value);
  document.getElementById('val-offset').textContent = (System.gridOffset > 0 ? '+' : '') + System.gridOffset + 'px';
  // Fast redraw of overlays only
  const cvs = UI.els.canvas;
  drawOverlays(parseFloat(cvs.style.width), parseFloat(cvs.style.height));
};
document.getElementById('btn-rst-grid').onclick = () => {
  System.gridOffset = 0;
  document.getElementById('rng-offset').value = 0;
  document.getElementById('val-offset').textContent = '0px';
  const cvs = UI.els.canvas;
  drawOverlays(parseFloat(cvs.style.width), parseFloat(cvs.style.height));
};

document.getElementById('rng-density').oninput = (e) => {
  System.gridLines = parseInt(e.target.value);
  document.getElementById('val-density').textContent = System.gridLines + ' LINES';
  const cvs = UI.els.canvas;
  drawOverlays(parseFloat(cvs.style.width), parseFloat(cvs.style.height));
};

// Toggles
document.getElementById('chk-ruler').onchange = (e) => { System.layers.ruler = e.target.checked; render(); };
document.getElementById('chk-margin').onchange = (e) => { System.layers.margin = e.target.checked; render(); };
document.getElementById('chk-grid').onchange = (e) => { System.layers.grid = e.target.checked; render(); };

// Keyboard
document.addEventListener('keydown', (e) => {
  if(!System.doc) return;
  if(e.key === 'ArrowLeft') document.getElementById('btn-prev').click();
  if(e.key === 'ArrowRight') document.getElementById('btn-next').click();
});

</script>
</body>
</html>
